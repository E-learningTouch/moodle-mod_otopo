{"version":3,"file":"report_group.min.js","sources":["../src/report_group.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Group report.\n *\n * @copyright   2024 Nantes Universit√© <support-tice@univ-nantes.fr> (Commissioner)\n * @copyright   2024 E-learning Touch' <contact@elearningtouch.com> (Maintainer)\n * @copyright   2022 Kosmos <moodle@kosmos.fr> (Former maintainer)\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['core/chartjs', 'core_table/dynamic', 'core/ajax', 'core/log'], function(Chart, DynamicTable, Ajax, Log) {\n    return {\n        init: function(uniqueid, wwwroot, moodlePre4) {\n\n            /**\n             * Export as a CSV file.\n             *\n             * @param {Event} e\n             */\n            function exportCSV(e) {\n                e.preventDefault();\n                const users = document.querySelector('#chart').dataset.users;\n                const cmid = document.getElementById('export-csv').dataset.cmid;\n                location.href = wwwroot + \"/mod/otopo/view.php?id=\" + cmid + \"&action=export&object=group&users=\" + users;\n            }\n\n            /**\n             * Load the chart using Ajax.\n             *\n             * @param {Number} otopo\n             * @param {Array<Number>} users\n             * @param {Number} session\n             * @returns {Promise}\n             */\n            async function loadAjaxChart(otopo, users, session) {\n                var promises = Ajax.call([\n                    {\n                        methodname: 'mod_otopo_get_group_chart', args: {\n                            otopo: otopo,\n                            users: users,\n                            session: session\n                        }\n                    }\n                ]);\n                const chart = await promises[0];\n\n                return chart;\n            }\n\n            /**\n             * Load the chart.\n             *\n             * @param {Number} otopo\n             * @param {Array<Number>} users\n             * @param {Number} session\n             */\n            function loadChart(otopo, users, session) {\n                loadAjaxChart(otopo, users, session).then((chart) => {\n                    if (chart) {\n                        const config = {\n                            data: chart,\n                            options: {}\n                        };\n                        const legend = {\n                            position: 'right',\n                        };\n                        const xScale = {\n                            stacked: true,\n                        };\n                        const yScale = {\n                            stacked: true,\n                            ticks: {\n                                beginAtZero: true,\n                                min: 0,\n                                max: 100,\n                                stepSize: 10\n                            }\n                        };\n                        if (moodlePre4) {\n                            config.type = 'horizontalBar';\n                            config.options.legend = legend;\n                            config.options.scales = {\n                                xAxes: [xScale],\n                                yAxes: [yScale]\n                            };\n                            config.options.tooltips = {\n                                callbacks: {\n                                    label: function(tooltipItem, data) {\n                                        let label = data.datasets[tooltipItem.datasetIndex].label || '';\n                                        label += ': ';\n                                        label += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || '0';\n                                        label += '%';\n                                        return label;\n                                    }\n                                }\n                            };\n                        } else {\n                            config.type = 'bar';\n                            config.options.indexAxis = 'y';\n                            config.options.scales = {\n                                x: xScale,\n                                y: yScale\n                            };\n                            config.options.plugins = {};\n                            config.options.plugins.legend = legend;\n                            config.options.plugins.tooltip = {\n                                callbacks: {\n                                    label: function(context) {\n                                        if (context) {\n                                            let label = context.dataset.label || '';\n                                            label += ': ';\n                                            label += context.formattedValue || '0';\n                                            label += '%';\n                                            return label;\n                                        }\n                                        return null;\n                                    }\n                                }\n                            };\n                        }\n                        new Chart(\n                            document.getElementById('chart'),\n                            config\n                        );\n                    }\n\n                    return true;\n                }).catch(Log.error);\n            }\n\n            const root = document.querySelector(`form[data-table-unique-id=\"${uniqueid}\"]`);\n\n            const otopo = root.dataset.otopo;\n            const chart = document.getElementById('chart');\n            if (chart) {\n                const users = document.querySelector('#chart').dataset.users.split(',');\n                const session = document.getElementById('session-selector')\n                      && parseInt(document.getElementById('session-selector').value) ?\n                      parseInt(document.getElementById('session-selector').value) : null;\n                loadChart(otopo, users, session);\n            }\n\n            root.addEventListener(DynamicTable.Events.tableContentRefreshed, () => {\n                const otopo = root.dataset.otopo;\n                const chart = document.getElementById('chart');\n                if (chart) {\n                    const users = document.querySelector('#chart').dataset.users.split(',');\n                    const session = document.getElementById('session-selector')\n                          && parseInt(document.getElementById('session-selector').value) ?\n                          parseInt(document.getElementById('session-selector').value) : null;\n                    if (users) {\n                        loadChart(otopo, users, session);\n                    }\n                }\n            });\n\n            var lastWidth = 0;\n            var lastHeight = 0;\n            window.onbeforeprint = () => {\n                for (var id in Chart.instances) {\n                    lastHeight = Chart.instances[id].canvas.parentNode.style.height;\n                    lastWidth = Chart.instances[id].canvas.parentNode.style.width;\n                    Chart.instances[id].canvas.parentNode.style.height = '1000px';\n                    Chart.instances[id].canvas.parentNode.style.width = '850px';\n                    Chart.instances[id].resize();\n                }\n            };\n            window.addEventListener('afterprint', () => {\n                for (var id in Chart.instances) {\n                    Chart.instances[id].canvas.parentNode.style.height = lastHeight;\n                    Chart.instances[id].canvas.parentNode.style.width = lastWidth;\n                    Chart.instances[id].resize();\n                }\n            });\n\n            const exportCSVBtn = document.getElementById('export-csv');\n            if (exportCSVBtn) {\n                exportCSVBtn.onclick = function(e) {\n                    exportCSV(e);\n                };\n            }\n        }\n    };\n});\n"],"names":["define","Chart","DynamicTable","Ajax","Log","init","uniqueid","wwwroot","moodlePre4","async","loadAjaxChart","otopo","users","session","promises","call","methodname","args","loadChart","then","chart","config","data","options","legend","position","xScale","stacked","yScale","ticks","beginAtZero","min","max","stepSize","type","scales","xAxes","yAxes","tooltips","callbacks","label","tooltipItem","datasets","datasetIndex","index","indexAxis","x","y","plugins","tooltip","context","dataset","formattedValue","document","getElementById","catch","error","root","querySelector","split","parseInt","value","addEventListener","Events","tableContentRefreshed","lastWidth","lastHeight","window","onbeforeprint","id","instances","canvas","parentNode","style","height","width","resize","exportCSVBtn","onclick","e","preventDefault","cmid","location","href","exportCSV"],"mappings":"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"}