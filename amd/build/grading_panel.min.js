define("mod_otopo/grading_panel",["jquery","core/yui","core/notification","core/templates","core/fragment","core/ajax","core/str","mod_assign/grading_form_change_checker","mod_assign/grading_events","core/event"],(function(e,t,o,n,i,s,r,a,d,l){var g=function(t){this._regionSelector=t,this._region=e(t),this._userCache=[],this.registerEventListeners()};return g.prototype._regionSelector=null,g.prototype._lastUserId=0,g.prototype._lastSession=0,g.prototype._region=null,g.prototype.nextUserId=null,g.prototype.nextUser=!1,g.prototype._niceReplaceNodeContents=function(t,o,i){var s=e.Deferred();return t.fadeOut("fast",(function(){n.replaceNodeContents(t,o,i),t.fadeIn("fast",(function(){s.resolve()}))})),s.promise()},g.prototype._saveFormState=function(){var t=e('[data-region="grading-actions-form"] [name="sendstudentnotifications"]').prop("checked");e('.gradeform [name="sendstudentnotifications"]').val(t)},g.prototype._submitForm=function(t,n,i){var r=e(this._region.find("form.gradeform"));e('[data-region="overlay"]').show(),r.trigger("save-form-state"),l.notifyFormSubmitAjax(r[0]);var a=r.serialize(),d=this._region.attr("data-otopoid"),g=[];this._region.find(".grade-item textarea").each((function(){e(this).val()&&g.push({id:e(this).data("item"),value:e(this).val()})})),s.call([{methodname:"mod_otopo_submit_grading_form",args:{otopo:d,userid:this._lastUserId,session:this._lastSession,jsonformdata:JSON.stringify(a),itemscomments:g},done:this._handleFormSubmissionResponse.bind(this,a,n,i),fail:o.exception}])},g.prototype._handleFormSubmissionResponse=function(n,i,s,a){void 0===i&&(i=this._lastUserId),a.length?e(document).trigger("reset",[this._lastUserId,this._lastSession,n]):(r.get_strings([{key:"changessaved",component:"core"},{key:"gradechangessaveddetail",component:"mod_assign"}]).done((function(e){o.alert(e[0],e[1])})).fail(o.exception),t.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),i==this._lastUserId?e(document).trigger("reset",[i,this._lastSession]):s?e(document).trigger("done-saving-show-next",!0):e(document).trigger("user-changed",i)),e('[data-region="overlay"]').hide()},g.prototype._resetForm=function(t,o,n,i){var s=e.Event("custom");void 0===o&&(o=this._lastUserId),this._lastUserId=0,void 0===n&&(n=this._lastSession),this._refreshGradingPanel(s,o,n,i,(function(){e(document).trigger("session-changed",[o,n,!1,!0])}))},g.prototype._addPopoutButtons=function(t){var i=e(t);n.render("mod_assign/popout_button",{}).done(function(e){i.find('[data-fieldtype="filemanager"],[data-fieldtype="editor"],[data-fieldtype="grading"]').closest(".fitem").addClass("has-popout").find("label").parent().append(e),i.on("click",'[data-region="popout-button"]',this._togglePopout.bind(this))}.bind(this)).fail(o.exception)},g.prototype._togglePopout=function(t){t.preventDefault();var o=e(t.target).closest(".fitem");o.hasClass("popout")?e(".popout").removeClass("popout"):(e(".popout").removeClass("popout"),o.addClass("popout"),o.addClass("moodle-has-zindex"))},g.prototype._refreshGradingPanel=function(t,s,r,d){let l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;var g=this._region.attr("data-contextid");void 0===d&&(d=""),this._lastUserId==s&&this._lastSession==r&&""===d||(this._lastUserId=s,this._lastSession=r,e(document).trigger("start-loading-user"),window.M.util.js_pending("mod-assign-loading-user"),n.render("mod_assign/loading",{}).done(function(t,n){this._niceReplaceNodeContents(this._region,t,n).done(function(){if(s>0){this._region.show();var t={userid:s,session:r,jsonformdata:JSON.stringify(d)};i.loadFragment("mod_otopo","gradingpanel",g,t).done(function(t,n){this._niceReplaceNodeContents(this._region,t,n).done(function(){a.saveFormState('[data-region="grade-panel"] .gradeform'),e(document).on("editor-content-restored",(function(){a.saveFormState('[data-region="grade-panel"] .gradeform')})),this._addPopoutButtons('[data-region="grade-panel"] .gradeform'),e(document).trigger("finish-loading-user"),null!==l&&"function"==typeof l&&l(),window.M.util.js_complete("mod-assign-loading-user")}.bind(this)).fail(o.exception)}.bind(this)).fail(o.exception),e('[data-region="review-panel"]').show()}else this._region.hide(),e('[data-region="review-panel"]').hide(),e(document).trigger("finish-loading-user"),window.M.util.js_complete("mod-assign-loading-user")}.bind(this))}.bind(this)).fail(o.exception))},g.prototype._getNextUser=function(e,t){this.nextUserId=t.nextUserId,this.nextUser=t.nextUser},g.prototype._handleSaveAndShowNext=function(){this._submitForm(null,this.nextUserId,this.nextUser)},g.prototype.getPanelElement=function(){return e('[data-region="grade-panel"]')},g.prototype.collapsePanel=function(){this.getPanelElement().addClass("collapsed")},g.prototype.expandPanel=function(){this.getPanelElement().removeClass("collapsed")},g.prototype.registerEventListeners=function(){var t=e(document);e(this._region).on("submit","form",(function(e){e.preventDefault()})),t.on("next-user",this._getNextUser.bind(this)),t.on("session-changed",this._refreshGradingPanel.bind(this)),t.on("save-changes",this._submitForm.bind(this)),t.on("save-and-show-next",this._handleSaveAndShowNext.bind(this)),t.on("reset",this._resetForm.bind(this)),t.on("save-form-state",this._saveFormState.bind(this)),t.on(d.COLLAPSE_GRADE_PANEL,function(){this.collapsePanel()}.bind(this)),t.on(d.COLLAPSE_REVIEW_PANEL,function(){this.expandPanel()}.bind(this)),t.on(d.EXPAND_GRADE_PANEL,function(){this.expandPanel()}.bind(this))},g}));

//# sourceMappingURL=grading_panel.min.js.map