{"version":3,"file":"evolution.min.js","sources":["../src/evolution.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Evolution.\n *\n * @copyright   2024 Nantes Universit√© <support-tice@univ-nantes.fr> (Commissioner)\n * @copyright   2024 E-learning Touch' <contact@elearningtouch.com> (Maintainer)\n * @copyright   2022 Kosmos <moodle@kosmos.fr> (Former maintainer)\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'core/notification',\n    'core/templates',\n    'core/ajax',\n    'core/chartjs',\n    'core/log'\n], function(\n    Notification,\n    Templates,\n    Ajax,\n    Chart,\n    Log\n) {\n    return {\n        init: function(otopo, degreeStr) {\n\n            /**\n             * Load the evolution using Ajax.\n             *\n             * @param {Number} otopo\n             * @param {String} visual\n             * @param {Number} item\n             * @returns {Promise}\n             */\n            async function loadAjaxEvolution(otopo, visual, item) {\n                var promises = Ajax.call([\n                    {\n                        methodname: 'mod_otopo_get_my_evolution',\n                        args: {\n                            otopo: otopo,\n                            visual: visual,\n                            item: item\n                        }\n                    }\n                ]);\n                const chart = await promises[0];\n\n                return chart;\n            }\n\n            /**\n             * Reload the page.\n             *\n             * @param {Number} otopo\n             */\n            function reloadPage(otopo) {\n                const visual = document.getElementById('id_visual').value;\n                const item = parseInt(document.getElementById('id_item').value);\n\n                loadAjaxEvolution(parseInt(otopo), visual, item).then((data) => {\n                    data.hascharts = data.charts.length > 0;\n                    data.currentchart = data.currentchart.id ? data.currentchart : null;\n                    data.chartitem = data.chartitem.id ? data.chartitem : null;\n                    data.star = document.getElementById('evolution').dataset.star;\n\n                    Templates.renderForPromise('mod_otopo/evol', data).then(({html, js}) => {\n                        Templates.replaceNodeContents('#evolution', html, js);\n                        let options;\n                        if (visual == 'radar') {\n                            options = {\n                                scale: {\n                                    ticks: {\n                                        min: 0,\n                                        max: data.max,\n                                        stepSize: 1\n                                    }\n                                },\n                                scales: {\n                                    r: {\n                                        beginAtZero: true\n                                    }\n                                }\n                            };\n                        } else {\n                            const yScale = {\n                                ticks: {\n                                    beginAtZero: true,\n                                    min: 0,\n                                    max: data.max,\n                                    stepSize: 1,\n                                    callbacks: function(value) {\n                                        if (value === 0) {\n                                            return \"\";\n                                        }\n                                        return degreeStr + \" \" + value;\n                                    }\n                                }\n                            };\n                            const legend = {display: false};\n                            if (data.moodlePre4) {\n                                options = {\n                                    scales: {\n                                        yAxes: [yScale]\n                                    }\n                                };\n                                options.legend = legend;\n                            } else {\n                                options = {\n                                    scales: {\n                                        y: yScale\n                                    }\n                                };\n                                options.plugins = {};\n                                options.plugins.legend = legend;\n                            }\n                        }\n                        if (data.moodlePre4) {\n                            options.tooltips = {\n                                displayColors: false,\n                                callbacks: {\n                                    title: function(tooltipItems, chart) {\n                                        return chart.fullLabels[tooltipItems[0].index];\n                                    },\n                                    label: function(tooltipItem, data) {\n                                        let label = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || '0';\n                                        label += data.datasets[tooltipItem.datasetIndex].labels[tooltipItem.index] ?\n                                            (' - ' + data.datasets[tooltipItem.datasetIndex].labels[tooltipItem.index]) : '';\n                                        return label;\n                                    }\n                                }\n                            };\n                        } else {\n                            if (!options.plugins) {\n                                options.plugins = {};\n                            }\n                            options.plugins.tooltip = {\n                                displayColors: false,\n                                callbacks: {\n                                    title: function(context) {\n                                        if (context.length > 0 && context[0].label) {\n                                            return context[0].label;\n                                        }\n                                        return null;\n                                    },\n                                    label: function(context) {\n                                        if (context) {\n                                            let label = context.formattedValue || '0';\n                                            label += context.dataset.labels[context.dataIndex] ?\n                                                (' - ' + context.dataset.labels[context.dataIndex]) : '';\n                                            return label;\n                                        }\n                                        return null;\n                                    }\n                                }\n                            };\n                        }\n                        const currentChartElement = document.getElementById('currentChart');\n                        if (currentChartElement && data.currentchart) {\n                            const config = {\n                                type: visual,\n                                data: data.currentchart,\n                                options: options\n                            };\n                            new Chart(\n                                currentChartElement,\n                                config\n                            );\n                        }\n\n                        data.charts.forEach(function(chart) {\n                            const chartElement = document.getElementById('chart' + chart.id);\n                            if (chartElement) {\n                                const config = {\n                                    type: visual,\n                                    data: chart,\n                                    options: options\n                                };\n                                new Chart(\n                                    chartElement,\n                                    config\n                                );\n                            }\n                        });\n\n                        const chartItemElement = document.getElementById('chartItem');\n                        if (chartItemElement && data.chartitem) {\n                            if (data.moodlePre4) {\n                                options.tooltips = {\n                                    displayColors: false,\n                                    callbacks: {\n                                        label: function(tooltipItem, data) {\n                                            var label = data.label || '';\n                                            if (label) {\n                                                label += ': ';\n                                            }\n                                            label += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || '0';\n                                            label += data.fullLabels[tooltipItem.index] ?\n                                                (' - ' + data.fullLabels[tooltipItem.index]) : '';\n                                            return label;\n                                        }\n                                    }\n                                };\n                            } else {\n                                if (!options.plugins) {\n                                    options.plugins = {};\n                                }\n                                options.plugins.tooltip = {\n                                    displayColors: false,\n                                    callbacks: {\n                                        title: function(context) {\n                                            if (context.length > 0 && context[0].label) {\n                                                return context[0].label;\n                                            }\n                                            return null;\n                                        },\n                                        label: function(context) {\n                                            if (context) {\n                                                let label = context.formattedValue || '0';\n                                                label += ': ';\n                                                label += context.dataset.label ? context.dataset.label : '';\n                                                return label;\n                                            }\n                                            return null;\n                                        }\n                                    }\n                                };\n                            }\n                            const config = {\n                                type: visual,\n                                data: data.chartitem,\n                                options: options\n                            };\n                            new Chart(\n                                chartItemElement,\n                                config\n                            );\n                        }\n                        return true;\n                    }).catch(Notification.exception);\n                    return true;\n                }).catch(Log.error);\n            }\n\n            document.getElementById('id_visual').onchange = function() {\n                reloadPage(otopo);\n            };\n            document.getElementById('id_item').onchange = function() {\n                reloadPage(otopo);\n            };\n\n            reloadPage(otopo);\n\n            var lastWidth = 0;\n            var lastHeight = 0;\n            window.onbeforeprint = function() {\n                for (var id in Chart.instances) {\n                    lastHeight = Chart.instances[id].canvas.parentNode.style.height;\n                    lastWidth = Chart.instances[id].canvas.parentNode.style.width;\n                    Chart.instances[id].canvas.parentNode.style.height = '850px';\n                    Chart.instances[id].canvas.parentNode.style.width = '850px';\n                    Chart.instances[id].resize();\n                }\n            };\n            window.addEventListener('afterprint', function() {\n                for (var id in Chart.instances) {\n                    Chart.instances[id].canvas.parentNode.style.height = lastHeight;\n                    Chart.instances[id].canvas.parentNode.style.width = lastWidth;\n                    Chart.instances[id].resize();\n                }\n            });\n        }\n    };\n});\n"],"names":["define","Notification","Templates","Ajax","Chart","Log","init","otopo","degreeStr","async","loadAjaxEvolution","visual","item","promises","call","methodname","args","reloadPage","document","getElementById","value","parseInt","then","data","hascharts","charts","length","currentchart","id","chartitem","star","dataset","renderForPromise","a","options","html","js","replaceNodeContents","scale","ticks","min","max","stepSize","scales","r","beginAtZero","yScale","callbacks","legend","display","moodlePre4","yAxes","y","plugins","tooltips","displayColors","title","tooltipItems","chart","fullLabels","index","label","tooltipItem","datasets","datasetIndex","labels","tooltip","context","formattedValue","dataIndex","currentChartElement","config","type","forEach","chartElement","chartItemElement","catch","exception","error","onchange","lastWidth","lastHeight","window","onbeforeprint","instances","canvas","parentNode","style","height","width","resize","addEventListener"],"mappings":"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"}