define("mod_otopo/participantsfilter_41",["core/datafilter/filtertypes/courseid","./local/datafilter/filtertypes/otopo","./local/datafilter/filtertypes/session","core_table/dynamic","core/datafilter/filtertype","core/str","core/notification","core/pending","core/datafilter/selectors","core/templates","core/custom_interaction_events","jquery"],(function(e,t,r,l,i,n,o,s,a,c,f,d){return{init:function(u,y){const p=document.querySelector(`#${u}`),h={courseid:new e("courseid",p),otopo:new t("otopo",p)};y&&(h.session=new r("session",p));const g=function(){p.querySelector(a.filterset.regions.filterlist)},v=function(){const e=new s("core_user/participantsfilter:addFilterRow"),t=1+g().querySelectorAll(a.filter.region).length;return c.renderForPromise("core/datafilter/filter_row",{rownumber:t}).then((e=>{let{html:t,js:r}=e;return c.appendNodeContents(g(),t,r)})).then((e=>{const t=p.querySelector(a.data.typeList);return e.forEach((e=>{const r=e.querySelector(a.filter.fields.type);r&&(r.innerHTML=t.innerHTML)})),e})).then((e=>(F(),e))).then((t=>(e.resolve(),t))).catch(o.exception)},m=async function(e,t,r){e.dataset.filterType=t;const l=function(e){return p.querySelector(a.filterset.regions.datasource).querySelector(a.data.fields.byName(e))}(t);let n=i;l.dataset.filterTypeClass&&(n=await import(l.dataset.filterTypeClass)),h[t]=new n(t,p,r);const o=e.querySelector(a.filter.fields.type);return o.value=t,o.disabled="disabled",F(),h[t]},q=function(e,t){1===g().querySelectorAll(a.filter.region).length?b(e,t):S(e,t)},S=async function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=!!e.querySelector(a.filter.fields.type).value;w(e.dataset.filterType),e.remove(),F(),r&&t&&L();const l=await T();g().querySelectorAll(a.filter.region).forEach(((e,t)=>{e.querySelector("legend").innerText=l[t]}))},b=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return w(e.dataset.filterType),c.renderForPromise("core/datafilter/filter_row",{rownumber:r}).then((t=>{let{html:r,js:l}=t;return c.replaceNode(e,r,l)})).then((e=>{const t=p.querySelector(a.data.typeList);return e.forEach((e=>{const r=e.querySelector(a.filter.fields.type);r&&(r.innerHTML=t.innerHTML)})),e})).then((e=>(F(),e))).then((e=>t?L():e)).catch(o.exception)},w=function(e){if(e){const t=function(e){return h[e]}(e);t&&(t.tearDown(),delete h[e])}},F=function(){const e=g().querySelectorAll(a.filter.region);e.forEach((e=>{e.querySelectorAll(a.filter.fields.type+" option").forEach((t=>{t.value===e.dataset.filterType?(t.classList.remove("hidden"),t.disabled=!1):h[t.value]?(t.classList.add("hidden"),t.disabled=!0):(t.classList.remove("hidden"),t.disabled=!1)}))}));const t=p.querySelector(a.filterset.actions.addRow);p.querySelectorAll(a.data.fields.all).length<=e.length?t.setAttribute("disabled","disabled"):t.removeAttribute("disabled"),1===e.length?(p.querySelector(a.filterset.regions.filtermatch).classList.add("hidden"),p.querySelector(a.filterset.fields.join).value=1,p.dataset.filterverb=1):p.querySelector(a.filterset.regions.filtermatch).classList.remove("hidden")},L=function(){const e=new s("core_user/participantsfilter:updateTableFromFilter"),t={};return Object.values(h).forEach((e=>{t[e.filterValue.name]=e.filterValue})),l.setFilters(l.getTableFromId(p.dataset.tableRegion),{jointype:parseInt(p.querySelector(a.filterset.fields.join).value,10),filters:t}).then((t=>(e.resolve(),t))).catch(o.exception)},T=async function(){const e=document.querySelector(a.data.typeListSelect).length-1;let t=[];[...Array(e)].forEach(((e,r)=>{t.push({key:"filterrowlegend",component:"core",param:r+1})}));const r=await n.get_strings(t).then((e=>e)).catch(o.exception);return r};p.querySelector(a.filterset.region).addEventListener("click",(e=>{e.target.closest(a.filterset.actions.addRow)&&(e.preventDefault(),v()),e.target.closest(a.filterset.actions.applyFilters)&&(e.preventDefault(),L()),e.target.closest(a.filterset.actions.resetFilters)&&(e.preventDefault(),function(){const e=new s("core_user/participantsfilter:setFilterFromConfig");g().querySelectorAll(a.filter.region).forEach((e=>q(e,!1))),L().then((t=>(e.resolve(),t)))}())})),p.querySelector(a.filterset.regions.filterlist).addEventListener("click",(e=>{e.target.closest(a.filter.actions.remove)&&(e.preventDefault(),q(e.target.closest(a.filter.region),!0))}));let E=d(g());f.define(E,[f.events.accessibleChange]),E.on(f.events.accessibleChange,(e=>{const t=e.target.closest(a.filter.fields.type);if(t&&t.value){const r=e.target.closest(a.filter.region);m(r,t.value)}})),p.querySelector(a.filterset.fields.join).addEventListener("change",(e=>{p.dataset.filterverb=e.target.value}));const _=l.getTableFromId(p.dataset.tableRegion),j=l.getFilters(_);if(j){const e=new s("core_user/participantsfilter:setFilterFromConfig");(function(e){const t=Object.entries(e.filters);if(!t.length)return Promise.resolve();p.querySelector(a.filterset.fields.join).value=e.jointype;const r=t.map((e=>{let[t,r]=e;if("courseid"===t)return!1;if("otopo"===t)return!1;if("session"===t)return!1;const l=r.values;return!!l.length&&v().then((e=>{let[r]=e;return m(r,t,l)}))})).filter((e=>e));return r.length?Promise.all(r).then((()=>{g().querySelectorAll(a.filter.region).forEach((e=>{!e.querySelector(a.filter.fields.type).value&&q(e,!1)}))})).then(F).then(L):Promise.resolve()})(j).then((()=>e.resolve())).catch()}}}}));

//# sourceMappingURL=participantsfilter_41.min.js.map