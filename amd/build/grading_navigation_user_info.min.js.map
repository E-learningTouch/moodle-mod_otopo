{"version":3,"file":"grading_navigation_user_info.min.js","sources":["../src/grading_navigation_user_info.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"User summary\" panel at the top of the page.\n *\n * @module     mod_assign/grading_navigation_user_info\n * @class      UserInfo\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/templates', 'core/str'],\n       function($, notification, ajax, templates, str) {\n\n    /**\n     * UserInfo class.\n     *\n     * @class UserInfo\n     * @param {String} selector The selector for the page region containing the user navigation.\n     * @param {String|JQuery} sessionSelector\n     */\n    var UserInfo = function(selector, sessionSelector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._sessionRegionSelector = sessionSelector;\n        this._sessionRegion = $(sessionSelector);\n\n        $(document).on('user-changed', this._refreshUserInfoAndLoadSessions.bind(this));\n        $(document).on('session-changed', this._refreshUserInfo.bind(this));\n\n        str.get_strings([\n            {key: 'lastmodification', component: 'otopo'},\n        ]).done((function(strs) {\n            this._lastModificationStr = strs[0];\n        }).bind(this)).fail(notification.exception);\n    };\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    UserInfo.prototype._regionSelector = null;\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    UserInfo.prototype._sessionRegionSelector = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    UserInfo.prototype._region = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    UserInfo.prototype._sessionRegion = null;\n\n    /** @type {Number} Remember the last user id to prevent unnecessary reloads. */\n    UserInfo.prototype._lastUserId = 0;\n\n    /** @type {Number} Remember the last session id to prevent unnecessary reloads. */\n    UserInfo.prototype._lastSessionId = 0;\n\n    UserInfo.prototype._lastModificationStr = '';\n\n    /**\n     * Get the assignment id\n     *\n     * @private\n     * @method _getOtopoId\n     * @return {Number} otopo id\n     */\n    UserInfo.prototype._getOtopoId = function() {\n        return this._region.attr('data-otopoid');\n    };\n\n    UserInfo.prototype._refreshUserInfoAndLoadSessions = function(event, userid) {\n        var session = this._lastSessionId > 0 ?\n            this._lastSessionId :\n            $('[data-region=\"grading-navigation-panel\"]').data('first-session');\n        this._refreshUserInfo(event, userid, session, true);\n    };\n    /**\n     * Get the user context - re-render the template in the page.\n     *\n     * @private\n     * @method _refreshUserInfo\n     * @param {Event} event\n     * @param {Number} userid\n     * @param {Number} session\n     * @param {Boolean} loadSessions\n     * @param {Boolean} force\n     */\n    UserInfo.prototype._refreshUserInfo = function(event, userid, session, loadSessions = false, force = false) {\n        var promise = $.Deferred();\n\n        // Put the current user ID in the DOM so yui can access it.\n        this._region.attr('data-userid', userid);\n\n        // Skip reloading if it is the same user.\n        if (this._lastUserId == userid && session && this._lastSessionId == session && !force) {\n            return;\n        }\n        this._lastUserId = userid;\n        this._lastSessionId = session;\n\n        // First insert the loading template.\n        templates.render('mod_assign/loading', {}).done(function(html, js) {\n            // Update the page.\n            this._region.fadeOut(\"fast\", function() {\n                templates.replaceNodeContents(this._region, html, js);\n                this._region.fadeIn(\"fast\");\n            }.bind(this));\n\n            if (userid < 0) {\n                // Render the template.\n                templates.render('mod_assign/grading_navigation_no_users', {}).done(function(html, js) {\n                    if (userid == this._lastUserId) {\n                        // Update the page.\n                        this._region.fadeOut(\"fast\", function() {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }\n                }.bind(this)).fail(notification.exception);\n                return;\n            }\n\n            // Load context from ajax.\n            var otopoId = this._getOtopoId();\n            var requests = ajax.call([{\n                methodname: 'mod_otopo_get_participant',\n                args: {\n                    userid: userid,\n                    otopo: otopoId,\n                    session: session\n                }\n            }]);\n\n            requests[0].done(function(participant) {\n                if (!participant.hasOwnProperty('id')) {\n                    promise.reject('No users');\n                } else {\n                    promise.resolve(participant);\n\n                }\n            }).fail(notification.exception);\n\n            promise.done(function(context) {\n                $(document).trigger('participant-loaded', context);\n\n                $('#grading-actions-buttons button').prop('disabled', !context.session.validated);\n\n                var identityfields = $('[data-showuseridentity]').data('showuseridentity').split(','),\n                    identity = [];\n\n                // Render the template.\n                context.courseid = $('[data-region=\"grading-navigation-panel\"]').attr('data-courseid');\n\n                if (context.user) {\n                    // Build a string for the visible identity fields listed in showuseridentity config setting.\n                    $.each(identityfields, function(i, k) {\n                        if (typeof context.user[k] !== 'undefined' && context.user[k] !== '') {\n                            context.hasidentity = true;\n                            identity.push(context.user[k]);\n                        }\n                    });\n                    context.identity = identity.join(', ');\n\n                    // Add profile image url to context.\n                    if (context.user.profileimageurl) {\n                        context.profileimageurl = context.user.profileimageurl;\n                    }\n                }\n\n                templates.render('mod_otopo/grading_navigation_user_summary', context).done(function(html, js) {\n                    // Update the page.\n                    if (userid == this._lastUserId) {\n                        this._region.fadeOut(\"fast\", function() {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }\n                }.bind(this)).fail(notification.exception);\n\n                if (loadSessions) {\n                    var firstSession = $('[data-region=\"grading-navigation-panel\"]').data('first-session');\n                    templates.render('mod_otopo/grading_navigation_session_selector', context).done(function(html, js) {\n                        if (userid == this._lastUserId) {\n                            this._sessionRegion.fadeOut(\"fast\", function() {\n                                templates.replaceNodeContents(this._sessionRegion, html, js);\n                                this._setLastModification(context.session.lastmodification);\n                                this._sessionRegion.fadeIn(\"fast\");\n                                this._sessionRegion.find('[data-action=\"change-session\"]')\n                                    .on('change', this._handleChangeSession.bind(this));\n                            }.bind(this));\n                        }\n                    }.bind(this)).fail(notification.exception);\n                    $(document).trigger('session-changed', [this._lastUserId, firstSession]);\n                } else {\n                    this._setLastModification(context.session.lastmodification);\n                }\n            }.bind(this)).fail(function() {\n                // Render the template.\n                templates.render('mod_assign/grading_navigation_no_users', {}).done(function(html, js) {\n                    // Update the page.\n                    this._region.fadeOut(\"fast\", function() {\n                        templates.replaceNodeContents(this._region, html, js);\n                        this._region.fadeIn(\"fast\");\n                    }.bind(this));\n                }.bind(this)).fail(notification.exception);\n            }\n            .bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    UserInfo.prototype._setLastModification = function(lastmodification) {\n        if (lastmodification) {\n            this._sessionRegion.find('#otopo_lastmodification')\n                .html(this._lastModificationStr + ': ' + lastmodification);\n        } else {\n            this._sessionRegion.find('#otopo_lastmodification')\n                .html('');\n        }\n    };\n\n    UserInfo.prototype._handleChangeSession = function() {\n        var select = this._sessionRegion.find('[data-action=change-session]');\n        var session = parseInt(select.val(), 10);\n\n        var url = new URL(window.location);\n        url.searchParams.set('session', session);\n        // We do this so a browser refresh will return to the same user.\n        window.history.replaceState({}, \"\", url);\n\n        $(document).trigger('session-changed', [this._lastUserId, session]);\n    };\n\n    return UserInfo;\n});\n"],"names":["define","$","notification","ajax","templates","str","UserInfo","selector","sessionSelector","this","_regionSelector","_region","_sessionRegionSelector","_sessionRegion","document","on","_refreshUserInfoAndLoadSessions","bind","_refreshUserInfo","get_strings","key","component","done","strs","_lastModificationStr","fail","exception","prototype","_lastUserId","_lastSessionId","_getOtopoId","attr","event","userid","session","data","loadSessions","arguments","length","undefined","force","promise","Deferred","render","html","js","fadeOut","replaceNodeContents","fadeIn","otopoId","call","methodname","args","otopo","participant","hasOwnProperty","resolve","reject","context","trigger","prop","validated","identityfields","split","identity","courseid","user","each","i","k","hasidentity","push","join","profileimageurl","firstSession","_setLastModification","lastmodification","find","_handleChangeSession","select","parseInt","val","url","URL","window","location","searchParams","set","history","replaceState"],"mappings":"AAwBAA,OAAO,yCAAA,CAAC,SAAU,oBAAqB,YAAa,iBAAkB,aAC/D,SAASC,EAAGC,EAAcC,EAAMC,EAAWC,GAS9C,IAAIC,EAAW,SAASC,EAAUC,GAC9BC,KAAKC,gBAAkBH,EACvBE,KAAKE,QAAUV,EAAEM,GACjBE,KAAKG,uBAAyBJ,EAC9BC,KAAKI,eAAiBZ,EAAEO,GAExBP,EAAEa,UAAUC,GAAG,eAAgBN,KAAKO,gCAAgCC,KAAKR,OACzER,EAAEa,UAAUC,GAAG,kBAAmBN,KAAKS,iBAAiBD,KAAKR,OAE7DJ,EAAIc,YAAY,CACZ,CAACC,IAAK,mBAAoBC,UAAW,WACtCC,KAAM,SAASC,GACdd,KAAKe,qBAAuBD,EAAK,EACrC,EAAGN,KAAKR,OAAOgB,KAAKvB,EAAawB,UACrC,EAmMA,OAhMApB,EAASqB,UAAUjB,gBAAkB,KAGrCJ,EAASqB,UAAUf,uBAAyB,KAG5CN,EAASqB,UAAUhB,QAAU,KAG7BL,EAASqB,UAAUd,eAAiB,KAGpCP,EAASqB,UAAUC,YAAc,EAGjCtB,EAASqB,UAAUE,eAAiB,EAEpCvB,EAASqB,UAAUH,qBAAuB,GAS1ClB,EAASqB,UAAUG,YAAc,WAC7B,OAAOrB,KAAKE,QAAQoB,KAAK,eAC7B,EAEAzB,EAASqB,UAAUX,gCAAkC,SAASgB,EAAOC,GACjE,IAAIC,EAAUzB,KAAKoB,eAAiB,EAChCpB,KAAKoB,eACL5B,EAAE,4CAA4CkC,KAAK,iBACvD1B,KAAKS,iBAAiBc,EAAOC,EAAQC,GAAS,EAClD,EAYA5B,EAASqB,UAAUT,iBAAmB,SAASc,EAAOC,EAAQC,GAA8C,IAArCE,KAAYC,UAAAC,OAAA,QAAAC,IAAAF,UAAAE,KAAAF,aAAUG,KAAKH,UAAAC,OAAAD,QAAAE,IAAAF,eAAAA,UAAA,GAC9F,IAAII,EAAUxC,EAAEyC,WAGhBjC,KAAKE,QAAQoB,KAAK,cAAeE,GAG7BxB,KAAKmB,aAAeK,GAAUC,GAAWzB,KAAKoB,gBAAkBK,IAAYM,IAGhF/B,KAAKmB,YAAcK,EACnBxB,KAAKoB,eAAiBK,EAGtB9B,EAAUuC,OAAO,qBAAsB,CAAE,GAAErB,KAAK,SAASsB,EAAMC,GAO3D,GALApC,KAAKE,QAAQmC,QAAQ,OAAQ,WACzB1C,EAAU2C,oBAAoBtC,KAAKE,QAASiC,EAAMC,GAClDpC,KAAKE,QAAQqC,OAAO,OACxB,EAAE/B,KAAKR,OAEHwB,EAAS,EAET7B,EAAUuC,OAAO,yCAA0C,IAAIrB,KAAK,SAASsB,EAAMC,GAC3EZ,GAAUxB,KAAKmB,aAEfnB,KAAKE,QAAQmC,QAAQ,OAAQ,WACzB1C,EAAU2C,oBAAoBtC,KAAKE,QAASiC,EAAMC,GAClDpC,KAAKE,QAAQqC,OAAO,OACxB,EAAE/B,KAAKR,MAEf,EAAEQ,KAAKR,OAAOgB,KAAKvB,EAAawB,eAVpC,CAeA,IAAIuB,EAAUxC,KAAKqB,cACJ3B,EAAK+C,KAAK,CAAC,CACtBC,WAAY,4BACZC,KAAM,CACFnB,OAAQA,EACRoB,MAAOJ,EACPf,QAASA,MAIR,GAAGZ,MAAK,SAASgC,GACjBA,EAAYC,eAAe,MAG5Bd,EAAQe,QAAQF,GAFhBb,EAAQgB,OAAO,WAKvB,IAAGhC,KAAKvB,EAAawB,WAErBe,EAAQnB,KAAK,SAASoC,GAClBzD,EAAEa,UAAU6C,QAAQ,qBAAsBD,GAE1CzD,EAAE,mCAAmC2D,KAAK,YAAaF,EAAQxB,QAAQ2B,WAEvE,IAAIC,EAAiB7D,EAAE,2BAA2BkC,KAAK,oBAAoB4B,MAAM,KAC7EC,EAAW,GA+Bf,GA5BAN,EAAQO,SAAWhE,EAAE,4CAA4C8B,KAAK,iBAElE2B,EAAQQ,OAERjE,EAAEkE,KAAKL,GAAgB,SAASM,EAAGC,QACA,IAApBX,EAAQQ,KAAKG,IAA0C,KAApBX,EAAQQ,KAAKG,KACvDX,EAAQY,aAAc,EACtBN,EAASO,KAAKb,EAAQQ,KAAKG,IAEnC,IACAX,EAAQM,SAAWA,EAASQ,KAAK,MAG7Bd,EAAQQ,KAAKO,kBACbf,EAAQe,gBAAkBf,EAAQQ,KAAKO,kBAI/CrE,EAAUuC,OAAO,4CAA6Ce,GAASpC,KAAK,SAASsB,EAAMC,GAEnFZ,GAAUxB,KAAKmB,aACfnB,KAAKE,QAAQmC,QAAQ,OAAQ,WACzB1C,EAAU2C,oBAAoBtC,KAAKE,QAASiC,EAAMC,GAClDpC,KAAKE,QAAQqC,OAAO,OACxB,EAAE/B,KAAKR,MAEf,EAAEQ,KAAKR,OAAOgB,KAAKvB,EAAawB,WAE5BU,EAAc,CACd,IAAIsC,EAAezE,EAAE,4CAA4CkC,KAAK,iBACtE/B,EAAUuC,OAAO,gDAAiDe,GAASpC,KAAK,SAASsB,EAAMC,GACvFZ,GAAUxB,KAAKmB,aACfnB,KAAKI,eAAeiC,QAAQ,OAAQ,WAChC1C,EAAU2C,oBAAoBtC,KAAKI,eAAgB+B,EAAMC,GACzDpC,KAAKkE,qBAAqBjB,EAAQxB,QAAQ0C,kBAC1CnE,KAAKI,eAAemC,OAAO,QAC3BvC,KAAKI,eAAegE,KAAK,kCACpB9D,GAAG,SAAUN,KAAKqE,qBAAqB7D,KAAKR,MACrD,EAAEQ,KAAKR,MAEf,EAAEQ,KAAKR,OAAOgB,KAAKvB,EAAawB,WAChCzB,EAAEa,UAAU6C,QAAQ,kBAAmB,CAAClD,KAAKmB,YAAa8C,GAC9D,WACSC,qBAAqBjB,EAAQxB,QAAQ0C,iBAElD,EAAE3D,KAAKR,OAAOgB,KAAK,WAEfrB,EAAUuC,OAAO,yCAA0C,CAAE,GAAErB,KAAK,SAASsB,EAAMC,GAE/EpC,KAAKE,QAAQmC,QAAQ,OAAQ,WACzB1C,EAAU2C,oBAAoBtC,KAAKE,QAASiC,EAAMC,GAClDpC,KAAKE,QAAQqC,OAAO,OACxB,EAAE/B,KAAKR,MACX,EAAEQ,KAAKR,OAAOgB,KAAKvB,EAAawB,UACpC,EACCT,KAAKR,MAxFwC,CAyFlD,EAAEQ,KAAKR,OAAOgB,KAAKvB,EAAawB,WACpC,EAEApB,EAASqB,UAAUgD,qBAAuB,SAASC,GAC3CA,EACAnE,KAAKI,eAAegE,KAAK,2BACpBjC,KAAKnC,KAAKe,qBAAuB,KAAOoD,GAE7CnE,KAAKI,eAAegE,KAAK,2BACpBjC,KAAK,GAElB,EAEAtC,EAASqB,UAAUmD,qBAAuB,WACtC,IAAIC,EAAStE,KAAKI,eAAegE,KAAK,gCAClC3C,EAAU8C,SAASD,EAAOE,MAAO,IAEjCC,EAAM,IAAIC,IAAIC,OAAOC,UACzBH,EAAII,aAAaC,IAAI,UAAWrD,GAEhCkD,OAAOI,QAAQC,aAAa,CAAE,EAAE,GAAIP,GAEpCjF,EAAEa,UAAU6C,QAAQ,kBAAmB,CAAClD,KAAKmB,YAAaM,GAC9D,EAEO5B,CACX"}