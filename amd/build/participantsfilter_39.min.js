define("mod_otopo/participantsfilter_39",["core_user/local/participantsfilter/filtertypes/courseid","./local/participantsfilter/filtertypes/otopo","./local/participantsfilter/filtertypes/session","core_table/dynamic","core_user/local/participantsfilter/filter","core/str","core/notification","core/pending","core_user/local/participantsfilter/selectors","core/templates","core/custom_interaction_events","jquery"],(function(e,t,r,l,i,n,o,s,c,a,f,u){return{init:function(d,p){const y=document.querySelector(`#${d}`),h={courseid:new e("courseid",y),otopo:new t("otopo",y)};p&&(h.session=new r("session",y));const g=function(){y.querySelector(c.filterset.regions.filterlist)},v=function(){const e=new s("core_user/participantsfilter:addFilterRow"),t=1+g().querySelectorAll(c.filter.region).length;return a.renderForPromise("core_user/local/participantsfilter/filterrow",{rownumber:t}).then((e=>{let{html:t,js:r}=e;return a.appendNodeContents(g(),t,r)})).then((e=>{const t=y.querySelector(c.data.typeList);return e.forEach((e=>{const r=e.querySelector(c.filter.fields.type);r&&(r.innerHTML=t.innerHTML)})),e})).then((e=>(_(),e))).then((t=>(e.resolve(),t))).catch(o.exception)},m=async function(e,t,r){e.dataset.filterType=t;const l=(e=>y.querySelector(c.filterset.regions.datasource).querySelector(c.data.fields.byName(e)))(t);let n=i;l.dataset.filterTypeClass&&(n=await import(l.dataset.filterTypeClass)),h[t]=new n(t,y,r);const o=e.querySelector(c.filter.fields.type);return o.value=t,o.disabled="disabled",_(),h[t]},q=function(e,t){1===g().querySelectorAll(c.filter.region).length?b(e,t):S(e,t)},S=async function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=!!e.querySelector(c.filter.fields.type).value;w(e.dataset.filterType),e.remove(),_(),r&&t&&F();const l=await L();g().querySelectorAll(c.filter.region).forEach(((e,t)=>{e.querySelector("legend").innerText=l[t]}))},b=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return w(e.dataset.filterType),a.renderForPromise("core_user/local/participantsfilter/filterrow",{rownumber:r}).then((t=>{let{html:r,js:l}=t;return a.replaceNode(e,r,l)})).then((e=>{const t=y.querySelector(c.data.typeList);return e.forEach((e=>{const r=e.querySelector(c.filter.fields.type);r&&(r.innerHTML=t.innerHTML)})),e})).then((e=>(_(),e))).then((e=>t?F():e)).catch(o.exception)},w=function(e){if(e){const t=function(e){return h[e]}(e);t&&(t.tearDown(),delete h[e])}},_=function(){const e=g().querySelectorAll(c.filter.region);e.forEach((e=>{e.querySelectorAll(c.filter.fields.type+" option").forEach((t=>{t.value===e.dataset.filterType?(t.classList.remove("hidden"),t.disabled=!1):h[t.value]?(t.classList.add("hidden"),t.disabled=!0):(t.classList.remove("hidden"),t.disabled=!1)}))}));const t=y.querySelector(c.filterset.actions.addRow);y.querySelectorAll(c.data.fields.all).length<=e.length?t.setAttribute("disabled","disabled"):t.removeAttribute("disabled"),1===e.length?(y.querySelector(c.filterset.regions.filtermatch).classList.add("hidden"),y.querySelector(c.filterset.fields.join).value=1,y.dataset.filterverb=1):y.querySelector(c.filterset.regions.filtermatch).classList.remove("hidden")},F=function(){const e=new s("core_user/participantsfilter:updateTableFromFilter"),t={};return Object.values(h).forEach((e=>{t[e.filterValue.name]=e.filterValue})),l.setFilters(l.getTableFromId(y.dataset.tableRegion),{jointype:parseInt(y.querySelector(c.filterset.fields.join).value,10),filters:t}).then((t=>(e.resolve(),t))).catch(o.exception)},L=async function(){const e=document.querySelector(c.data.typeListSelect).length-1;let t=[];[...Array(e)].forEach(((e,r)=>{t.push({key:"filterrowlegend",component:"core_user",param:r+1})}));const r=await n.get_strings(t).then((e=>e)).catch(o.exception);return r};y.querySelector(c.filterset.region).addEventListener("click",(e=>{e.target.closest(c.filterset.actions.addRow)&&(e.preventDefault(),v()),e.target.closest(c.filterset.actions.applyFilters)&&(e.preventDefault(),F()),e.target.closest(c.filterset.actions.resetFilters)&&(e.preventDefault(),function(){const e=new s("core_user/participantsfilter:setFilterFromConfig");g().querySelectorAll(c.filter.region).forEach((e=>q(e,!1))),F().then((t=>(e.resolve(),t)))}())})),y.querySelector(c.filterset.regions.filterlist).addEventListener("click",(e=>{e.target.closest(c.filter.actions.remove)&&(e.preventDefault(),q(e.target.closest(c.filter.region),!0))}));let T=u(g());f.define(T,[f.events.accessibleChange]),T.on(f.events.accessibleChange,(e=>{const t=e.target.closest(c.filter.fields.type);if(t&&t.value){const r=e.target.closest(c.filter.region);m(r,t.value)}})),y.querySelector(c.filterset.fields.join).addEventListener("change",(e=>{y.dataset.filterverb=e.target.value}));const E=l.getTableFromId(y.dataset.tableRegion),j=l.getFilters(E);if(j){const e=new s("core_user/participantsfilter:setFilterFromConfig");(function(e){const t=Object.entries(e.filters);if(!t.length)return Promise.resolve();y.querySelector(c.filterset.fields.join).value=e.jointype;const r=t.map((e=>{let[t,r]=e;if("courseid"===t)return!1;if("otopo"===t)return!1;if("session"===t)return!1;const l=r.values;return!!l.length&&v().then((e=>{let[r]=e;return m(r,t,l)}))})).filter((e=>e));return r.length?Promise.all(r).then((()=>{g().querySelectorAll(c.filter.region).forEach((e=>{!e.querySelector(c.filter.fields.type).value&&q(e,!1)}))})).then(_).then(F):Promise.resolve()})(j).then((()=>e.resolve())).catch()}}}}));

//# sourceMappingURL=participantsfilter_39.min.js.map