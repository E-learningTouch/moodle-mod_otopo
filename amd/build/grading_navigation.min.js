define("mod_otopo/grading_navigation",["jquery","core/notification","core/str","core/form-autocomplete","core/ajax","mod_assign/grading_form_change_checker"],(function(e,t,n,s,i,o){var r=function(i){this._regionSelector=i,this._region=e(i),this._users=[],this._lastXofYUpdate=0,this._firstLoadUsers=!0,this._loadAllUsers(),this._region.find('[data-action="previous-user"]').on("click",this._handlePreviousUser.bind(this)),this._region.find('[data-action="next-user"]').on("click",this._handleNextUser.bind(this)),this._region.find('[data-action="change-user"]').on("change",this._handleChangeUser.bind(this)),e(document).on("user-changed",this._refreshSelector.bind(this)),e(document).on("done-saving-show-next",this._handleNextUser.bind(this));var o=e('[data-region="grading-navigation-panel"]').data("first-userid");o&&this._selectUserById(o),n.get_string("changeuser","mod_assign").done((function(e){s.enhance("[data-action=change-user]",!1,"mod_otopo/participant_selector",e)})).fail(t.exception),e(document).bind("start-loading-user",function(){this._isLoading=!0}.bind(this)),e(document).bind("finish-loading-user",function(){this._isLoading=!1}.bind(this))};return r.prototype._isLoading=!1,r.prototype._regionSelector=null,r.prototype._region=null,r.prototype._loadAllUsers=function(){var e=this._region.find("[data-action=change-user]").attr("data-otopoid");return i.call([{methodname:"mod_otopo_list_participants",args:{otopo:e,filter:""},done:this._usersLoaded.bind(this),fail:t.exception}]),!0},r.prototype._usersLoaded=function(e){this._firstLoadUsers=!1,this._users=e,this._users.length?this._refreshCount():this._selectNoUser(),this._triggerNextUserEvent()},r.prototype._selectNoUser=function(){this._isLoading||(o.checkFormForChanges('[data-region="grade-panel"] .gradeform')?n.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done((function(n){t.confirm(n[0],n[1],n[2],n[3],(function(){e(document).trigger("save-changes",-1)}))})):e(document).trigger("user-changed",-1))},r.prototype._selectUserById=function(s){var i=this._region.find("[data-action=change-user]"),r=parseInt(s,10);this._isLoading||(o.checkFormForChanges('[data-region="grade-panel"] .gradeform')?n.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done((function(n){t.confirm(n[0],n[1],n[2],n[3],(function(){e(document).trigger("save-changes",r)}))})):(i.attr("data-selected",s),!isNaN(r)&&r>0&&e(document).trigger("user-changed",s)))},r.prototype._handlePreviousUser=function(e){e.preventDefault();var t=this._region.find("[data-action=change-user]").attr("data-selected"),n=0,s=0;for(n=0;n<this._users.length;n++)if(this._users[n].id==t){s=n;break}var i=this._users.length,o=s-1;o<0&&(o=i-1),i&&this._selectUserById(this._users[o].id)},r.prototype._handleNextUser=function(t,n){t.preventDefault();var s=this._region.find("[data-action=change-user]"),i=s.attr("data-selected"),o=0,r=0;for(o=0;o<this._users.length;o++)if(this._users[o].id==i){r=o;break}var a=this._users.length,d=(r+1)%a;if(n&&a){var c=this._users[d].id,g=parseInt(c,10);s.attr("data-selected",c),!isNaN(g)&&g>0&&e(document).trigger("user-changed",c)}else a&&this._selectUserById(this._users[d].id)},r.prototype._setCountString=function(e,s){var i;this._lastXofYUpdate++,i=this._lastXofYUpdate,n.get_string("xofy","mod_assign",{x:e,y:s}).done(function(e){i==this._lastXofYUpdate&&this._region.find('[data-region="user-count-summary"]').text(e)}.bind(this)).fail(t.exception)},r.prototype._refreshCount=function(){var e=this._region.find("[data-action=change-user]").attr("data-selected"),t=0,n=0;if(isNaN(e)||e<=0)this._region.find('[data-region="user-count"]').hide();else{for(this._region.find('[data-region="user-count"]').show(),t=0;t<this._users.length;t++)if(this._users[t].id==e){n=t;break}var s=this._users.length;if(s&&(n+=1),this._setCountString(n,s),n>0){var i=new URL(window.location);i.searchParams.set("user",e),window.history.replaceState({},"",i)}}},r.prototype._refreshSelector=function(e,t){var n=this._region.find("[data-action=change-user]");t=parseInt(t,10),!isNaN(t)&&t>0&&n.attr("data-selected",t),this._refreshCount()},r.prototype._triggerNextUserEvent=function(){this._users.length>1?e(document).trigger("next-user",{nextUserId:null,nextUser:!0}):e(document).trigger("next-user",{nextUser:!1})},r.prototype._handleChangeUser=function(){var s=this._region.find("[data-action=change-user]"),i=parseInt(s.val(),10);this._isLoading||(o.checkFormForChanges('[data-region="grade-panel"] .gradeform')?n.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done((function(n){t.confirm(n[0],n[1],n[2],n[3],(function(){e(document).trigger("save-changes",i)}))})):!isNaN(i)&&i>0&&(s.attr("data-selected",i),e(document).trigger("user-changed",i)))},r}));

//# sourceMappingURL=grading_navigation.min.js.map