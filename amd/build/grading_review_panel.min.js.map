{"version":3,"file":"grading_review_panel.min.js","sources":["../src/grading_review_panel.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"User summary\" panel at the top of the page.\n *\n * @module     mod_assign/grading_review_panel\n * @class      UserInfo\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'mod_assign/grading_events', 'core/notification', 'core/templates', 'core/str', 'core/chartjs'],\n       function($, GradingEvents, notification, templates, str, Chart) {\n\n    /**\n     * UserInfo class.\n     *\n     * @class UserInfo\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var GradingReviewPanel = function(selector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n\n        this.registerEventListeners();\n\n        $(document).on('participant-loaded', this._refreshReviewPanel.bind(this));\n\n        str.get_strings([\n            {key: 'autoevaldegree', component: 'otopo'}\n        ]).done(function(strs) {\n            this._degreeStr = strs[0];\n        }).fail(notification.exception);\n\n        this._visual = this._region.data('otopovisual');\n        this._star = this._region.data('star');\n        this._starContainer = this._region.data('star-container');\n        this._help = this._region.data('help');\n    };\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    GradingReviewPanel.prototype._regionSelector = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    GradingReviewPanel.prototype._region = null;\n\n    GradingReviewPanel.prototype._visual = 'radar';\n\n    GradingReviewPanel.prototype._degreeStr = '';\n\n    GradingReviewPanel.prototype._star = '';\n\n    GradingReviewPanel.prototype._starContainer = '';\n\n    GradingReviewPanel.prototype._help = '';\n\n    GradingReviewPanel.prototype._refreshReviewPanel = function(event, context) {\n        if (context.session.id) {\n            context.star = this._star;\n            context.help = this._help;\n            context.starcontainer = this._starContainer;\n            context.items.forEach(function(item) {\n                if ('otopodegreedescription' in item) {\n                    item.otopodegreedescription = item.otopodegreedescription.replace(/\\n/g, \"<br />\");\n                }\n            });\n            if (!context.sessionchart.label) {\n                context.sessionchart = null;\n            }\n            templates.render('mod_otopo/grading_review', context).done(function(html, js) {\n                this._region.fadeOut(\"fast\", function() {\n                    templates.replaceNodeContents(this._region, html, js);\n                    let options;\n                    if (this._visual == 'radar') {\n                        options = {\n                            scale: {\n                                ticks: {\n                                    min: 0,\n                                    max: context.max,\n                                    stepSize: 1\n                                }\n                            },\n                            scales: {\n                                r: {\n                                    beginAtZero: true\n                                }\n                            }\n                        };\n                    } else {\n                        const yScale = {\n                            ticks: {\n                                beginAtZero: true,\n                                min: 0,\n                                max: context.max,\n                                stepSize: 1,\n                                callbacks: function(value) {\n                                    if (value === 0) {\n                                        return \"\";\n                                    }\n                                    return this._degreeStr + \" \" + value;\n                                }\n                            }\n                        };\n                        const legend = {display: false};\n                        if (context.moodlePre4) {\n                            options = {\n                                scales: {\n                                    yAxes: [yScale]\n                                }\n                            };\n                            options.legend = legend;\n                        } else {\n                            options = {\n                                scales: {\n                                    y: yScale\n                                }\n                            };\n                            options.plugins = {};\n                            options.plugins.legend = legend;\n                        }\n                    }\n                    if (context.moodlePre4) {\n                        options.tooltips = {\n                            displayColors: false,\n                            callbacks: {\n                                title: function(tooltipItems, chart) {\n                                    return chart.fullLabels[tooltipItems[0].index];\n                                },\n                                label: function(tooltipItem, data) {\n                                    let label = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || '0';\n                                    label += data.datasets[tooltipItem.datasetIndex].labels[tooltipItem.index] ?\n                                        (' - ' + data.datasets[tooltipItem.datasetIndex].labels[tooltipItem.index]) : '';\n                                    return label;\n                                }\n                            }\n                        };\n                    } else {\n                        if (!options.plugins) {\n                            options.plugins = {};\n                        }\n                        options.plugins.tooltip = {\n                            displayColors: false,\n                            callbacks: {\n                                title: function(context) {\n                                    if (context.length > 0 && context[0].label) {\n                                        return context[0].label;\n                                    }\n                                    return null;\n                                },\n                                label: function(context) {\n                                    if (context) {\n                                        let label = context.formattedValue || '0';\n                                        label += context.dataset.labels[context.dataIndex] ?\n                                            (' - ' + context.dataset.labels[context.dataIndex]) : '';\n                                        return label;\n                                    }\n                                    return null;\n                                }\n                            }\n                        };\n                    }\n                    const sessionChartElement = document.getElementById('sessionChart');\n                    if (sessionChartElement && context.sessionchart) {\n                        const config = {\n                            type: this._visual,\n                            data: context.sessionchart,\n                            options: options\n                        };\n                        new Chart(\n                            sessionChartElement,\n                            config\n                        );\n                    }\n\n                    this._region.fadeIn(\"fast\");\n                }.bind(this));\n            }.bind(this)).fail(notification.exception);\n        } else {\n            this._region.html('');\n        }\n    };\n\n    /**\n     * Get the toggle review panel button.\n     *\n     * @method getTogglePanelButton\n     * @return {jQuery}\n     */\n    GradingReviewPanel.prototype.getTogglePanelButton = function() {\n        return this.getPanelElement().find('[data-region=\"review-panel-toggle\"]');\n    };\n\n    /**\n     * Get the review panel element.\n     *\n     * @method getPanelElement\n     * @return {jQuery}\n     */\n    GradingReviewPanel.prototype.getPanelElement = function() {\n        return $('[data-region=\"review-panel\"]');\n    };\n\n    /**\n     * Get the review panel content element.\n     *\n     * @method getPanelContentElement\n     * @return {jQuery}\n     */\n    GradingReviewPanel.prototype.getPanelContentElement = function() {\n        return $('[data-region=\"review-panel-content\"]');\n    };\n\n    /**\n     * Show/Hide the review panel.\n     *\n     * @method togglePanel\n     */\n    GradingReviewPanel.prototype.togglePanel = function() {\n        if (this.getPanelElement().hasClass('collapsed')) {\n            $(document).trigger(GradingEvents.EXPAND_REVIEW_PANEL);\n        } else {\n            $(document).trigger(GradingEvents.COLLAPSE_REVIEW_PANEL);\n        }\n    };\n\n    /**\n     * Hide the review panel.\n     *\n     * @method collapsePanel\n     */\n    GradingReviewPanel.prototype.collapsePanel = function() {\n        this.getPanelElement().addClass('collapsed').removeClass('grade-panel-collapsed');\n        this.getPanelContentElement().attr('aria-hidden', true);\n    };\n\n    /**\n     * Show the review panel.\n     *\n     * @method expandPanel\n     */\n    GradingReviewPanel.prototype.expandPanel = function() {\n        this.getPanelElement().removeClass('collapsed');\n        this.getPanelContentElement().removeAttr('aria-hidden');\n    };\n\n    /**\n     * Register event listeners for the review panel.\n     *\n     * @method registerEventListeners\n     */\n    GradingReviewPanel.prototype.registerEventListeners = function() {\n        var toggleReviewPanelButton = this.getTogglePanelButton();\n        toggleReviewPanelButton.click(function(e) {\n            this.togglePanel();\n            e.preventDefault();\n        }.bind(this));\n\n        toggleReviewPanelButton.keydown(function(e) {\n            if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\n                if (e.keyCode === 13 || e.keyCode === 32) {\n                    this.togglePanel();\n                    e.preventDefault();\n                }\n            }\n        }.bind(this));\n\n        var docElement = $(document);\n        docElement.on(GradingEvents.COLLAPSE_REVIEW_PANEL, function() {\n            this.collapsePanel();\n        }.bind(this));\n\n        // Need special styling when grade panel is collapsed.\n        docElement.on(GradingEvents.COLLAPSE_GRADE_PANEL, function() {\n            this.expandPanel();\n            this.getPanelElement().addClass('grade-panel-collapsed');\n        }.bind(this));\n\n        docElement.on(GradingEvents.EXPAND_REVIEW_PANEL, function() {\n            this.expandPanel();\n        }.bind(this));\n\n        docElement.on(GradingEvents.EXPAND_GRADE_PANEL, function() {\n            this.getPanelElement().removeClass('grade-panel-collapsed');\n        }.bind(this));\n    };\n\n    return GradingReviewPanel;\n});\n"],"names":["define","$","GradingEvents","notification","templates","str","Chart","GradingReviewPanel","selector","this","_regionSelector","_region","registerEventListeners","document","on","_refreshReviewPanel","bind","get_strings","key","component","done","strs","_degreeStr","fail","exception","_visual","data","_star","_starContainer","_help","prototype","event","context","session","id","star","help","starcontainer","items","forEach","item","otopodegreedescription","replace","sessionchart","label","render","html","js","fadeOut","options","replaceNodeContents","scale","ticks","min","max","stepSize","scales","r","beginAtZero","yScale","callbacks","value","legend","display","moodlePre4","yAxes","y","plugins","tooltips","displayColors","title","tooltipItems","chart","fullLabels","index","tooltipItem","datasets","datasetIndex","labels","tooltip","length","formattedValue","dataset","dataIndex","sessionChartElement","getElementById","config","type","fadeIn","getTogglePanelButton","getPanelElement","find","getPanelContentElement","togglePanel","hasClass","trigger","EXPAND_REVIEW_PANEL","COLLAPSE_REVIEW_PANEL","collapsePanel","addClass","removeClass","attr","expandPanel","removeAttr","toggleReviewPanelButton","click","e","preventDefault","keydown","metaKey","shiftKey","altKey","ctrlKey","keyCode","docElement","COLLAPSE_GRADE_PANEL","EXPAND_GRADE_PANEL"],"mappings":"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"}