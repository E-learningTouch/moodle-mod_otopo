define("mod_otopo/grading_navigation_user_info",["jquery","core/notification","core/ajax","core/templates","core/str"],(function(i,t,e,n,s){var o=function(e,n){this._regionSelector=e,this._region=i(e),this._sessionRegionSelector=n,this._sessionRegion=i(n),i(document).on("user-changed",this._refreshUserInfoAndLoadSessions.bind(this)),i(document).on("session-changed",this._refreshUserInfo.bind(this)),s.get_strings([{key:"lastmodification",component:"otopo"}]).done(function(i){this._lastModificationStr=i[0]}.bind(this)).fail(t.exception)};return o.prototype._regionSelector=null,o.prototype._sessionRegionSelector=null,o.prototype._region=null,o.prototype._sessionRegion=null,o.prototype._lastUserId=0,o.prototype._lastSessionId=0,o.prototype._lastModificationStr="",o.prototype._getOtopoId=function(){return this._region.attr("data-otopoid")},o.prototype._refreshUserInfoAndLoadSessions=function(t,e){var n=this._lastSessionId>0?this._lastSessionId:i('[data-region="grading-navigation-panel"]').data("first-session");this._refreshUserInfo(t,e,n,!0)},o.prototype._refreshUserInfo=function(s,o,a){let r=!!(arguments.length>3&&void 0!==arguments[3])&&arguments[3],d=!!(arguments.length>4&&void 0!==arguments[4])&&arguments[4];var h=i.Deferred();this._region.attr("data-userid",o),this._lastUserId==o&&a&&this._lastSessionId==a&&!d||(this._lastUserId=o,this._lastSessionId=a,n.render("mod_assign/loading",{}).done(function(s,d){if(this._region.fadeOut("fast",function(){n.replaceNodeContents(this._region,s,d),this._region.fadeIn("fast")}.bind(this)),o<0)n.render("mod_assign/grading_navigation_no_users",{}).done(function(i,t){o==this._lastUserId&&this._region.fadeOut("fast",function(){n.replaceNodeContents(this._region,i,t),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(t.exception);else{var g=this._getOtopoId();e.call([{methodname:"mod_otopo_get_participant",args:{userid:o,otopo:g,session:a}}])[0].done((function(i){i.hasOwnProperty("id")?h.resolve(i):h.reject("No users")})).fail(t.exception),h.done(function(e){i(document).trigger("participant-loaded",e),i("#grading-actions-buttons button").prop("disabled",!e.session.validated);var s=i("[data-showuseridentity]").data("showuseridentity").split(","),a=[];if(e.courseid=i('[data-region="grading-navigation-panel"]').attr("data-courseid"),e.user&&(i.each(s,(function(i,t){void 0!==e.user[t]&&""!==e.user[t]&&(e.hasidentity=!0,a.push(e.user[t]))})),e.identity=a.join(", "),e.user.profileimageurl&&(e.profileimageurl=e.user.profileimageurl)),n.render("mod_otopo/grading_navigation_user_summary",e).done(function(i,t){o==this._lastUserId&&this._region.fadeOut("fast",function(){n.replaceNodeContents(this._region,i,t),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(t.exception),r){var d=i('[data-region="grading-navigation-panel"]').data("first-session");n.render("mod_otopo/grading_navigation_session_selector",e).done(function(i,t){o==this._lastUserId&&this._sessionRegion.fadeOut("fast",function(){n.replaceNodeContents(this._sessionRegion,i,t),this._setLastModification(e.session.lastmodification),this._sessionRegion.fadeIn("fast"),this._sessionRegion.find('[data-action="change-session"]').on("change",this._handleChangeSession.bind(this))}.bind(this))}.bind(this)).fail(t.exception),i(document).trigger("session-changed",[this._lastUserId,d])}else this._setLastModification(e.session.lastmodification)}.bind(this)).fail(function(){n.render("mod_assign/grading_navigation_no_users",{}).done(function(i,t){this._region.fadeOut("fast",function(){n.replaceNodeContents(this._region,i,t),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(t.exception)}.bind(this))}}.bind(this)).fail(t.exception))},o.prototype._setLastModification=function(i){i?this._sessionRegion.find("#otopo_lastmodification").html(this._lastModificationStr+": "+i):this._sessionRegion.find("#otopo_lastmodification").html("")},o.prototype._handleChangeSession=function(){var t=this._sessionRegion.find("[data-action=change-session]"),e=parseInt(t.val(),10),n=new URL(window.location);n.searchParams.set("session",e),window.history.replaceState({},"",n),i(document).trigger("session-changed",[this._lastUserId,e])},o}));

//# sourceMappingURL=grading_navigation_user_info.min.js.map